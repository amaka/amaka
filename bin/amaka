#!/usr/bin/env php
<?php
/**
 * OfficineSoftware OIS
 *
 * @license   http://www.opensource.org/licenses/bsd-license.php
 * @copyright Copyright (c) 2012 Andrea Turso
 * @author    Andrea Turso <andrea.turso@gmail.com>
 */
require_once __DIR__ . '/../src/bootstrap.php';

use Zend\Console\Getopt;
use Officine\Amaka\Amaka;
use Officine\Amaka\Context\CliContext;
use Officine\Amaka\FailedBuildException;
use Officine\Amaka\AmakaScript\AmakaScriptNotFoundException;

$getopt = new Getopt(array(
    'f=s'    => 'Load the specified amaka script',
    'list|l' => 'Prints the tasks in the amaka script',
    'init'   => "Create a new amaka script with a ':hello-world' task",
    'help|h' => 'Show this help screen',
));

$opts = $getopt;
$args = $getopt->getRemainingArgs();
$task = array_pop($args);

$scriptName = null;
// Let the user load a different amaka script with -f
if (isset($opts->f)) {
    $scriptName = $opts->f;
}

if (isset($opts->help)) {
    echo $opts->getUsageMessage();
    die(0);
}

// Handle the creation of the new script
if (isset($opts->init)) {
    if (file_exists('Amkfile')) {
        echo "An 'Amkfile' is already present in this project. Aborting." . PHP_EOL;
    } else {
        $script = <<<AMK_SCRIPT
<?php
/**
  This is an example amaka script

  If your project has a 'tests/' directory and a 'phpunit.xml' file
  then you can run PHPUnit with 'amaka test'.
 */
return array(
    \$amaka->task(':hello-world', function() {
        echo "Hello World!" . PHP_EOL;
    }),
    \$amaka->task('test'),
);
AMK_SCRIPT;
            if (file_put_contents('Amkfile', $script)) {
                echo "The new 'Amkfile' script has been created successfully." . PHP_EOL;
                echo "Now you can run the hello world task with 'amaka :hello-world'" . PHP_EOL;
            } else {
                echo "Could not create the 'Amkfile' script." . PHP_EOL;
            }
        }
        return;
    }

try {
    $context = new CliContext();
    $context->setParam('args', $args);

    $amaka = new Amaka($scriptName, $context);
    $amaka->loadAmakaScript();

    if (isset($opts->l)) {
        $script = $amaka->getAmakaScript();
        foreach ($script as $task) {
            echo $task->getName() . PHP_EOL;
        }
        return;
    }

    echo "(Loaded '{$amaka->getAmakaScript()}')\n";
    $amaka->run($task);
} catch (AmakaScriptNotFoundException $e) {
    if (isset($opts->f)) {
        throw $e;
    }
    echo "Error: No amaka scripts to load found.\n";
    echo "Generate a default amaka script using the `--init' option.\n";

    exit(1);
} catch(Exception $e) {
    echo "Fatal (" . get_class($e) . "): {$e->getMessage()}\n";
    exit(1);
}
